<html><head>
<title>Composition String - Rei's Booth</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<link rel=stylesheet href="style.css">
</head>

<body bgcolor="#ffffff" text="#000000" link="#0066cc" vlink="#6b8e23" alink="#ff4500"><center>

<a name="top"></a>
<table width=85% border=0 cellspacing=0 cellpadding=0><tr><td>
<table width=100% border=0 cellspacing=0 cellpadding=0><tr>
<td><font face="verdana,arial,helvetica" size=1 color="#666666">
	<div class="ss"><a class="this" href= "index__2.html" ><b>Design</b></a>:
	<a class="nav" href= "index.html" >IMM Programming Tutorial</a>: 6
	</div></font></td>
<td nowrap><div align="right">
	<a href= "imm4.html" ><img src="../../lib/i-prev.png"
	border=0 width=13 height=12 alt="[Previous]"></a>
	<a href= "imm6.html" ><img src="../../lib/i-next.png"
	border=0 width=13 height=12 alt="[Next]"></a>
	<a href= "index.html" ><img src="../../lib/i-up.png"
	border=0 width=13 height=13 alt="[Up]"></a>
	<a href= "index__1.html" ><img src="../../lib/i-home.png"
	border=0 width=13 height=13 alt="[Home]"></a>
	<a href="http://thunder.prohosting.com/~reis/cgi-bin/reisbooth.cgi"><img src="../../lib/i-bbs.png"
	border=0 width=13 height=13 alt="[BBS]"></a></td>
</tr><tr>
<td colspan=2><img src="../../lib/trans.png" width=1 height=2></td>
</tr><tr>
<td colspan=2 bgcolor="#c0c0c0"><center><img src="../../lib/trans.png" width=1 height=2 alt="- - - - - - - - - - - - - - - - - - - -"></center></td>
</tr></table><br>

<table width=100% border=0 cellspacing=0 cellpadding=5 bgcolor="#eeeeee"><tr><td class="title">
<font face="arial,helvetica"><b>Composition String</b></font>
</td></tr></table><br>

<font face="arial,helvetica" size=2>

<table border=0 cellspacing=0 cellpadding=3 align="right"><tr>
<td align="center"><img src="img/compstr.png" width=75 height=15 alt="(compstr.png, 1KB)"></td>
</tr><tr><td align="center">
<font face="verdana,arial,helvetica" size=1 color="#666666" class="ss">Composition string</font></td>
</tr></table>

<p>A &quot;<i>Composition String</i>&quot; is a string which is not determined yet and can be converted, canceled or editted through the IME.</p>

<p>When the user starts to type the composition string, your application window will receive the <b>WM_IME_STARTCOMPOSITION</b> message from the IME, and then <b>WM_IME_COMPOSITION</b> will follow. Every time the user changes the string (with additional string or by converting it), <b>WM_IME_COMPOSITION</b> message will be sent. When the user determines or canceles the composition string, the window receives the <b>WM_IME_ENDCOMPOSITION</b> message.</p>

<p>To retrieve the current composition string, use <b>ImmGetCompositinoString</b> with <b>GCS_COMPSTR</b> index. If you want to know the reading of the compositon string, use <b>GCS_COMREADSTR</b> index.</p>

<p class="sp">&nbsp;</p>

<blockquote><table border=0 cellspacing=0 cellpadding=2 bgcolor="#c0c0c0"><tr><td>
<table border=0 cellspacing=0 cellpadding=8 bgcolor="#f5f5f5"><tr><td><pre>
HIMC hIMC;
LPTSTR lpstr; /* buffer to receive the string */
DWORD len;    /* buffer size to be needed (in bytes) */

if ((hIMC = ImmGetContext(hWnd)) != NULL) {
    /* allocate the buffer
       to receive the information. */
    len = ImmGetCompositionString(hIMC,
        GCS_COMPSTR, NULL, 0);
    lpstr = (LPTSTR)
        GlobalAllocPtr(GHND, len + sizeof(TCHAR));

    /* get the composition string. */
    ImmGetCompositionString(hIMC,
        GCS_COMPSTR, (LPVOID)lpstr, len);
    *(lpstr + len) = (TCHAR)'\0';

    /* do your process. */
    ...

    /* clean up. */
    GlobalFreePtr(lpstr);
    ImmReleaseContext(hWnd, hIMC);
}
</pre></td></tr></table>
</td></tr></table></blockquote>

<p class="sp">&nbsp;</p>

<table border=0 cellspacing=0 cellpadding=0><tr valign="top">
<td><font face="verdana,arial,helvetica" class="ss"><b>Note</b></font></td>
<td><img src="../../lib/trans.png" width=8 height=1 alt=":"></td>
<td><font face="arial,helvetica" size=2><div>All information specified by GCS_xxx are NOT always available. Usually <b>ImmGetCompositionString</b> is used in response to <b>WM_IME_ENDCOMPOSITION</b> (or <b>WM_IME_COMPOSITION</b>) message.</div></font></td>
</tr></table>

<p class="sp">&nbsp;</p>

<p>An application can set the composition string programmably to its context by <b>ImmSetCompositionString</b>. You pass the composition or reading string (or both) to be generated to the function. The result of <b>ImmSetCompositionString</b> will be a little different depending on the current IME. Especially, in Japanese case, some IMEs might not work as you expect when kanji characters are included in the composition string. And some IMEs like MS-IME 97 will perform roman-kana conversion if the reading string contains alphabets.</p>

<p>The following codes will generate (or change) a composition string if succeeded.</p>

<p class="sp">&nbsp;</p>

<table border=0 cellspacing=0 cellpadding=2 align="center" bgcolor="#c0c0c0"><tr><td>
<table border=0 cellspacing=0 cellpadding=8 bgcolor="#f5f5f5"><tr><td><pre>
dercolor="#c0c0c0"><tr><td><pre>
HIMC hIMC;
TCHAR szRead[] = _T("Reading String");
    /* reading string, see the Note below. */

if ((hIMC = ImmGetContext(hWnd)) != NULL) {
    ImmSetCompositionString(
        hIMC,
        SCS_SETSTR, /* set the composition string */
        NULL,       /* composition string */&nbsp;
        0,          /* length of the composition string */
        szRead,     /* reading string */
        (lstrlen(szRead) - 1) * sizeof(TCHAR)
                    /* length of the reading string */
    );
    ImmReleaseContext(hWnd, hIMC);
}
</pre></td></tr></table>
</td></tr></table>

<p class="sp">&nbsp;</p>

<table border=0 cellspacing=0 cellpadding=0><tr valign="top">
<td><font face="verdana,arial,helvetica" class="ss"><b>Note</b></font></td>
<td><img src="../../lib/trans.png" width=8 height=1 alt=":"></td>
<td><font face="arial,helvetica" size=2><div>As for Japanese IMEs, <i>szRead</i> variable should contain a string composed of katakana, alphabets, numbers and/or signs in half-shape, which indicates the reading of the composition string. Katakana's are used in kana input mode (when IME_CMODE_ROMAN is off) and alphabets are in roman input mode (IME_CMODE_ROMAN is on).<br>
Some IMEs may display the composition string without discarding NULL terminator. So, you should not include NULL in the length of the string to set.</div></font></td>
</tr></table>

<p class="sp">&nbsp;</p>

<p>Both <b>ImmGetCompositionString</b> and <b>ImmSetCompositionString</b> can also handle the attributes or clauses of the composition string. If you want your application to draw the composition string by itself like Microsoft Word, you need to retrieve the attribute information, clause information and cursor position by using <b>ImmGetCompositionString</b> sequentially with <b>GCS_xxxATTR</b>, <b>GCS_xxxCLAUSE</b> and <b>GCS_CURSORPOS</b> indices.</p>

</font>
<p class="sp">&nbsp;</p>

<table width=100% border=0 cellspacing=0 cellpadding=0><tr>
<td colspan=2 bgcolor="#c0c0c0"><center><img src="../../lib/trans.png" width=1 height=2 alt="- - - - - - - - - - - - - - - - - - - -"></center></td>
</tr><tr>
<td colspan=2><img src="../../lib/trans.png" width=1 height=3 alt=""></td>
</tr><tr>
<td><font face="verdana,arial,helvetica" size=1 color="#666666">
	<div class="ss"><a class="this" href= "index__2.html" ><b>Design</b></a>:
	<a class="nav" href= "index.html" >IMM Programming Tutorial</a>: 6
	</div></font></td>
<td><div align="right">
	<a href= "imm4.html" ><img src="../../lib/i-prev.png" border=0
	width=13 height=12 alt="[Previous]"></a>
	<a href= "imm6.html" ><img src="../../lib/i-next.png" border=0
	width=13 height=12 alt="[Next]"></a>
	<a href= "index.html" ><img src="../../lib/i-up.png" border=0
	width=13 height=13 alt="[Up]"></a>
	<a href= "index__1.html" ><img src="../../lib/i-home.png"
	border=0 width=13 height=13 alt="[Home]"></a>
	<a href="http://thunder.prohosting.com/~reis/cgi-bin/reisbooth.cgi"><img src="../../lib/i-bbs.png" border=0
	width=13 height=13 alt="[BBS]"></div></td>
</tr></table>
</td></tr></table>

</basefont></body></html>
